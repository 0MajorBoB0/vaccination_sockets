{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h2>Admin Dashboard</h2>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <span id="socketStatus" style="color: #6b7280;">ğŸ”Œ Verbinde...</span>
    <a href="{{ url_for('admin_logout') }}" style="color: #ef4444;">Logout</a>
  </div>
</div>

<div style="margin-bottom: 2rem;">
  <h3>Sessions <span style="font-size: 0.875rem; color: #6b7280;">(Live-Updates via Socket.IO)</span></h3>
  <div id="sessionsContainer">
    <p style="color: #6b7280;">Lade Sessions...</p>
  </div>
</div>

<div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
  <p><strong>âœ… Phase 1.2 erreicht:</strong> Admin-Login + Socket.IO funktioniert!</p>
  <p><strong>â­ï¸ NÃ¤chster Schritt:</strong> Session-Erstellung (Phase 1.3)</p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const statusEl = document.getElementById('socketStatus');
  const container = document.getElementById('sessionsContainer');

  // Connect event
  socket.on('connect', () => {
    console.log('âœ… Socket.IO connected:', socket.id);
    statusEl.textContent = 'ğŸŸ¢ Live verbunden';
    statusEl.style.color = '#10b981';

    // Join admin room and request initial data
    socket.emit('admin_connect');
    socket.emit('admin_get_sessions');
  });

  // Disconnect event
  socket.on('disconnect', () => {
    console.log('âŒ Socket.IO disconnected');
    statusEl.textContent = 'ğŸ”´ Getrennt';
    statusEl.style.color = '#ef4444';
  });

  // Admin status
  socket.on('admin_status', (data) => {
    console.log('ğŸ“Š Admin status:', data.message);
  });

  // Sessions update
  socket.on('admin_sessions_update', (data) => {
    console.log('ğŸ“Š Sessions update:', data.sessions);
    renderSessions(data.sessions);
  });

  // Render sessions table
  function renderSessions(sessions) {
    if (!sessions || sessions.length === 0) {
      container.innerHTML = `
        <p style="color: #6b7280;">Noch keine Sessions erstellt.</p>
        <p><em>Session-Erstellung kommt im nÃ¤chsten Schritt!</em></p>
      `;
      return;
    }

    const html = `
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f3f4f6; text-align: left;">
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Name</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Teilnehmer</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Gruppe</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Runden</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Startguthaben</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Erstellt</th>
            <th style="padding: 0.75rem; border: 1px solid #e5e7eb;">Status</th>
          </tr>
        </thead>
        <tbody>
          ${sessions.map(s => `
            <tr>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${s.name}</td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                <strong>${s.joined_count || 0}</strong> / ${s.total_participants || 0}
              </td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${s.group_size}</td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${s.rounds}</td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${s.starting_balance} ECU</td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">${s.created_at || 'N/A'}</td>
              <td style="padding: 0.75rem; border: 1px solid #e5e7eb;">
                ${s.archived ? '<span style="color: #6b7280;">Archiviert</span>' : '<span style="color: #10b981;">Aktiv</span>'}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    container.innerHTML = html;
  }

  // Auto-refresh every 10 seconds
  setInterval(() => {
    if (socket.connected) {
      socket.emit('admin_get_sessions');
    }
  }, 10000);
</script>
{% endblock %}
