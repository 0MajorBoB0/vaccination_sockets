{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
  <h2>Admin Dashboard</h2>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <span id="socketStatus" style="color: #6b7280;">üîå Verbinde...</span>
    <a href="{{ url_for('admin_logout') }}" style="color: #ef4444;">Logout</a>
  </div>
</div>

<h2>Neue Session anlegen</h2>
<form method="post">
  <div class="grid grid-3">
    <div>
      <label>Name</label>
      <input type="text" name="name" value="Session {{ now }}" required>
    </div>
    <div>
      <label>Gruppengr√∂√üe (N)</label>
      <input type="number" name="group_size" value="6" min="1" max="20" required>
    </div>
    <div>
      <label>Runden</label>
      <input type="number" name="rounds" value="20" min="1" max="200" required>
    </div>
  </div>

  <div class="grid grid-3">
    <div>
      <label>Basisbetrag M (pro Runde)</label>
      <input type="number" name="base_payout" value="500" step="1" required>
    </div>
    <div></div>
    <div></div>
  </div>
  <button type="submit">Session erstellen</button>
</form>

<hr>

<h2>Offene Sessions</h2>
<table class="table">
  <tr><th>Name</th><th>Codes</th><th>Parameter</th><th>Aktionen</th></tr>
  {% for s in sessions_active %}
    <tr>
      <td>
        {{ s['name'] }}
        <div class="badge mono">id={{ s['id'][:8] }}...</div>
      </td>
      <td>
        {% for p in s['participants'] %}
          <span class="kbd mono">{{ p['code'] }}</span>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td class="mono">
        N={{ s['group_size'] }}, R={{ s['rounds'] }}, M={{ '%.0f'|format(s['starting_balance']) }}
      </td>
      <td>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
          <a href="{{ url_for('admin_session_detail', session_id=s['id']) }}"
             style="display:block;background:#3a63ff;color:white;border-radius:8px;padding:8px 12px;text-decoration:none;text-align:center;font-size:14px">Details</a>
          <form method="post" action="/admin/reset_session" style="margin:0"
                onsubmit="return confirm('Session wirklich ZUR√úCKSETZEN? Alle Spieler m√ºssen neu joinen!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#f59e0b;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">‚Üª Reset</button>
          </form>
          <form method="post" action="/admin/delete_session" style="margin:0"
                onsubmit="return confirm('Session wirklich L√ñSCHEN? Alle Daten werden gel√∂scht!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#ef4444;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">L√∂schen</button>
          </form>
        </div>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="center" style="opacity:.7">‚Äì keine offenen Sessions ‚Äì</td></tr>
  {% endfor %}
</table>

<h2>Laufende Sessions</h2>
<table class="table">
  <tr><th>Name</th><th>Codes</th><th>Parameter</th><th>Aktionen</th></tr>
  {% for s in sessions_playing %}
    <tr>
      <td>
        {{ s['name'] }}
        <div class="badge mono">id={{ s['id'][:8] }}...</div>
      </td>
      <td>
        {% for p in s['participants'] %}
          <span class="kbd mono">{{ p['code'] }}</span>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td class="mono">
        N={{ s['group_size'] }}, R={{ s['rounds'] }}, M={{ '%.0f'|format(s['starting_balance']) }}
      </td>
      <td>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
          <a href="{{ url_for('admin_session_detail', session_id=s['id']) }}"
             style="display:block;background:#3a63ff;color:white;border-radius:8px;padding:8px 12px;text-decoration:none;text-align:center;font-size:14px">Details</a>
          <form method="post" action="/admin/reset_session" style="margin:0"
                onsubmit="return confirm('Session wirklich ZUR√úCKSETZEN? Alle Spieler m√ºssen neu joinen!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#f59e0b;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">‚Üª Reset</button>
          </form>
          <form method="post" action="/admin/delete_session" style="margin:0"
                onsubmit="return confirm('Session wirklich L√ñSCHEN? Alle Daten werden gel√∂scht!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#ef4444;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">L√∂schen</button>
          </form>
        </div>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="center" style="opacity:.7">‚Äì keine laufenden Sessions ‚Äì</td></tr>
  {% endfor %}
</table>

<h2>Abgeschlossene Sessions</h2>
<table class="table">
  <tr><th>Name</th><th>Codes</th><th>Parameter</th><th>Aktionen</th></tr>
  {% for s in sessions_done %}
    <tr>
      <td>
        {{ s['name'] }}
        <div class="badge mono">id={{ s['id'][:8] }}...</div>
      </td>
      <td>
        {% for p in s['participants'] %}
          <span class="kbd mono">{{ p['code'] }}</span>{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td class="mono">
        N={{ s['group_size'] }}, R={{ s['rounds'] }}, M={{ '%.0f'|format(s['starting_balance']) }}
      </td>
      <td>
        <div style="display:flex;flex-direction:column;gap:6px;min-width:120px">
          <a href="{{ url_for('admin_session_detail', session_id=s['id']) }}"
             style="display:block;background:#3a63ff;color:white;border-radius:8px;padding:8px 12px;text-decoration:none;text-align:center;font-size:14px">Details</a>
          <form method="post" action="/admin/reset_session" style="margin:0"
                onsubmit="return confirm('Session wirklich ZUR√úCKSETZEN? Alle Spieler m√ºssen neu joinen!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#f59e0b;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">‚Üª Reset</button>
          </form>
          <form method="post" action="/admin/delete_session" style="margin:0"
                onsubmit="return confirm('Session wirklich L√ñSCHEN? Alle Daten werden gel√∂scht!');">
            <input type="hidden" name="session_id" value="{{ s['id'] }}">
            <button style="width:100%;background:#ef4444;color:white;border-radius:8px;padding:8px 12px;border:0;font-size:14px;cursor:pointer" type="submit">L√∂schen</button>
          </form>
        </div>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="center" style="opacity:.7">‚Äì keine abgeschlossenen Sessions ‚Äì</td></tr>
  {% endfor %}
</table>

<!-- Stresstest Section -->
<div style="margin-top:2rem;padding:1.5rem;background:#1e293b;border-radius:12px;border:1px solid #334155">
  <h2 style="margin:0 0 1rem 0;font-size:1.25rem;color:#e2e8f0">üß™ Stresstest</h2>
  <p style="margin:0 0 1rem 0;opacity:0.8;font-size:0.9rem">Simuliere parallele Sessions mit jeweils 6 Spielern</p>

  <div style="display:flex;gap:1rem;align-items:end">
    <div style="flex:1;max-width:200px">
      <label style="display:block;margin-bottom:0.5rem;font-size:0.9rem;color:#cbd5e1">Anzahl Sessions</label>
      <input type="number" id="stressTestSessions" min="1" max="50" value="5"
             style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid #475569;background:#0f172a;color:white;font-size:1rem">
      <div style="font-size:0.75rem;margin-top:0.25rem;opacity:0.6">= <span id="totalPlayers">30</span> Spieler (6 pro Session)</div>
    </div>

    <button id="startStressTest" onclick="startStressTest()"
            style="padding:0.75rem 1.5rem;background:#10b981;color:white;border:0;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s"
            onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
      ‚ñ∂ Stresstest starten
    </button>
  </div>

  <div id="stressTestStatus" style="margin-top:1rem;padding:1rem;background:#0f172a;border-radius:8px;display:none">
    <div style="font-weight:600;margin-bottom:0.5rem">Status:</div>
    <div id="stressTestLog" style="font-family:monospace;font-size:0.85rem;max-height:300px;overflow-y:auto"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const statusEl = document.getElementById('socketStatus');

  // Connect event
  socket.on('connect', () => {
    console.log('‚úÖ Socket.IO connected:', socket.id);
    statusEl.textContent = 'üü¢ Live verbunden';
    statusEl.style.color = '#10b981';
    socket.emit('admin_connect');
  });

  // Disconnect event
  socket.on('disconnect', () => {
    console.log('‚ùå Socket.IO disconnected');
    statusEl.textContent = 'üî¥ Getrennt';
    statusEl.style.color = '#ef4444';
  });

  // Session created - reload page
  socket.on('session_created', (data) => {
    console.log('‚úÖ New session created:', data.session_id);
    location.reload();
  });

  // Session reset - reload page
  socket.on('session_reset_admin', (data) => {
    console.log('üîÑ Session reset:', data.session_id);
    location.reload();
  });

  // Session started (lobby ‚Üí playing)
  socket.on('session_started', (data) => {
    console.log('‚ñ∂Ô∏è Session started:', data.session_id);
    location.reload();
  });

  // Game finished (playing ‚Üí done)
  socket.on('game_finished', (data) => {
    console.log('üèÅ Game finished:', data.session_id);
    location.reload();
  });

  // Stresstest functions
  const sessionsInput = document.getElementById('stressTestSessions');
  const totalPlayersSpan = document.getElementById('totalPlayers');
  const stressTestBtn = document.getElementById('startStressTest');
  const statusDiv = document.getElementById('stressTestStatus');
  const logDiv = document.getElementById('stressTestLog');

  // Update total players when sessions input changes
  sessionsInput.addEventListener('input', () => {
    totalPlayersSpan.textContent = sessionsInput.value * 6;
  });

  function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
      info: '#94a3b8',
      success: '#10b981',
      error: '#ef4444',
      warning: '#f59e0b'
    };
    const color = colors[type] || colors.info;
    logDiv.innerHTML += `<div style="color:${color};margin:2px 0">[${timestamp}] ${message}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  async function startStressTest() {
    const numSessions = parseInt(sessionsInput.value);
    if (numSessions < 1 || numSessions > 50) {
      alert('Bitte zwischen 1 und 50 Sessions w√§hlen!');
      return;
    }

    // Disable button and show status
    stressTestBtn.disabled = true;
    stressTestBtn.textContent = '‚è≥ L√§uft...';
    stressTestBtn.style.opacity = '0.6';
    statusDiv.style.display = 'block';
    logDiv.innerHTML = '';

    addLog(`üöÄ Starte Stresstest mit ${numSessions} Sessions (${numSessions * 6} Spieler)...`, 'info');

    try {
      const response = await fetch('/admin/stress_test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({num_sessions: numSessions})
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      // Stream the response
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n').filter(l => l.trim());

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.substring(6));
            if (data.type === 'log') {
              addLog(data.message, data.level || 'info');
            } else if (data.type === 'complete') {
              addLog(`‚úÖ Stresstest abgeschlossen! ${data.message}`, 'success');
              setTimeout(() => location.reload(), 2000);
            } else if (data.type === 'error') {
              addLog(`‚ùå Fehler: ${data.message}`, 'error');
            }
          }
        }
      }
    } catch (error) {
      addLog(`‚ùå Fehler beim Stresstest: ${error.message}`, 'error');
    } finally {
      stressTestBtn.disabled = false;
      stressTestBtn.textContent = '‚ñ∂ Stresstest starten';
      stressTestBtn.style.opacity = '1';
    }
  }
</script>
{% endblock %}
