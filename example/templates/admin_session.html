{% extends "base.html" %}
{% block title %}Vaccination Game ‚Äì Session{% endblock %}

{% block content %}
<div class="page">

  <div class="toolbar" style="display:flex;gap:.75rem;align-items:center; margin-bottom:1rem;">
    <a class="btn" href="{{ url_for('admin_dashboard') }}">‚Üê Zur√ºck</a>
    <a class="btn btn-primary" href="{{ url_for('admin_export_session_xlsx') }}?session_id={{ session.id }}">‚¨á Download (.xlsx)</a>
    <div class="muted" style="margin-left:auto;">
      N={{ session.group_size }}, R={{ session.rounds }}, M={{ session.starting_balance }}
    </div>
  </div>

  <section class="card">
    <h3>{{ session.name }}</h3>
    <div class="muted tiny" style="margin-bottom:1rem;">
      Status: <span id="status_disp" style="font-weight:bold;color:#3a63ff;">{{ session.status }}</span> ‚Ä¢
      Session ID: <span class="mono">{{ session.id[:16] }}...</span>
    </div>

    <h4 style="margin-top:1.5rem;margin-bottom:0.5rem;">Live-Status</h4>
    <div class="muted tiny">
      Runde: <span id="round_disp">{{ round_number }}</span> ‚Ä¢
      Entschieden: <span id="decided_count">0</span>/<span id="group_size">{{ session.group_size }}</span> ‚Ä¢
      Bereit f√ºr n√§chste Runde: <span id="ready_count">0</span>/<span id="group_size2">{{ session.group_size }}</span>
    </div>

    <div class="table-wrap" style="margin-top:.75rem;">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Code</th>
            <th>Runde</th>
            <th>Entschieden</th>
            <th>Wahl</th>
            <th>Bereit</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const sid = "{{ session.id }}";
const rowsTbody = document.getElementById('rows');
const decidedCountSpan = document.getElementById('decided_count');
const readyCountSpan = document.getElementById('ready_count');
const roundDisp = document.getElementById('round_disp');
const statusDisp = document.getElementById('status_disp');
const groupSize = {{ session.group_size }};

const socket = io();

socket.on('connect', () => {
  console.log('‚úÖ Socket.IO connected:', socket.id);
  socket.emit('admin_connect');
  poll(); // Initial load
});

socket.on('disconnect', () => {
  console.log('‚ùå Socket.IO disconnected');
});

// Listen for any updates and refresh data
socket.on('round_decision', () => {
  console.log('üîÑ Round decision update');
  poll();
});

socket.on('player_ready', () => {
  console.log('üîÑ Player ready update');
  poll();
});

socket.on('all_ready', () => {
  console.log('üîÑ All ready update');
  poll();
});

socket.on('lobby_update', () => {
  console.log('üîÑ Lobby update');
  poll();
});

socket.on('session_reset_admin', () => {
  console.log('üîÑ Session reset');
  poll();
});

async function poll() {
  try {
    const url = "{{ url_for('admin_session_status') }}" + "?session_id=" + encodeURIComponent(sid);
    console.log('Polling:', url);
    const r = await fetch(url);
    if (!r.ok) {
      console.error('Fetch failed:', r.status);
      return;
    }
    const data = await r.json();
    console.log('Received data:', data);

    decidedCountSpan.textContent = data.decided_count ?? 0;
    readyCountSpan.textContent = data.ready_count ?? 0;
    roundDisp.textContent = data.session?.current_round ?? '{{ round_number }}';

    if (data.session?.status) {
      statusDisp.textContent = data.session.status;
    }

    rowsTbody.innerHTML = "";
    if (!data.participants || data.participants.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="7" style="text-align:center;opacity:0.7;">Keine Teilnehmer in dieser Session</td>';
      rowsTbody.appendChild(tr);
    } else {
      data.participants.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td class="mono">${p.code || '?'}</td>
          <td>${p.round_display || '?/?'}</td>
          <td>${p.decided ? "‚úì" : "‚Äì"}</td>
          <td>${p.choice ?? "‚Äì"}</td>
          <td class="${p.ready_for_next ? 'ready-yes' : ''}">${p.ready_for_next ? "‚úì" : "‚Äì"}</td>
          <td>${p.balance != null ? p.balance : "‚Äì"}</td>
        `;
        rowsTbody.appendChild(tr);
      });
    }

  } catch(e) {
    console.error('Poll error:', e);
  }
}

// Initial poll on page load
poll();
</script>

<style>
.page { display:flex; flex-direction:column; gap:1rem; }
.card { background:#0b1320; border:1px solid #1e2b43; border-radius:10px; padding:1rem; }
.btn { padding:.5rem .9rem; border-radius:8px; background:#24324d; color:#e8eefc; text-decoration:none; }
.btn-primary { background:#3a63ff; color:#fff; }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { padding:.55rem .6rem; border-bottom:1px solid #1e2b43; text-align:left; }
.tiny { font-size:.9rem; }
.muted { color:#aab7d4; }
.ready-yes { color:#4ade80; font-weight:bold; }
</style>
{% endblock %}
